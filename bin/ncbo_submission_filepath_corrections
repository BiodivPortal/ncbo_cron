#!/usr/bin/env ruby

# Exit cleanly from an early interrupt
Signal.trap("INT") { exit 1 }

# Setup the bundled gems in our environment
require 'bundler/setup'

# Used for getting jobs from the queue and processing them
require_relative '../lib/ncbo_cron'
config_exists = File.exist?(File.expand_path('../../config/config.rb', __FILE__))
abort("Please create a config/config.rb file using the config/config.rb.sample as a template") unless config_exists
require_relative '../config/config'



platform = "local"
if LinkedData.settings.goo_host.include? "stage"
  platform = "stage"
elsif LinkedData.settings.goo_host.include? "prod"
  platform = "prod"
end
puts "Running on #{platform} platform; repository = #{LinkedData.settings.repository_folder}"

ontologies = LinkedData::Models::Ontology.where.include(:acronym,:submissions,:summaryOnly).all
ontologies.sort! {|a,b| a.acronym.downcase <=> b.acronym.downcase }
ontologies.each do |ont|
  next if ont.summaryOnly
  ont.submissions.each do |sub|
    sub.bring(:uploadFilePath) if sub.bring?(:uploadFilePath)
    sub.bring(:pullLocation) if sub.bring?(:pullLocation)
    sub.bring(:submissionId) if sub.bring?(:submissionId)
  end
  submissions = ont.submissions.sort {|a,b| a.submissionId <=> b.submissionId }
  submissions.each do |sub|
    if sub.uploadFilePath.nil?
      # Why is this nil?
      printf("%-15s\t\tsubmission: %3d; uploadFilePath: nil\n", "#{ont.acronym}:", sub.submissionId)
      next
    end
    if sub.uploadFilePath.include? "#{ont.acronym}/#{sub.submissionId}"
      # This could be OK
      unless sub.uploadFilePath.include? LinkedData.settings.repository_folder
        printf("%-15s\t\tsubmission: %3d; uploadFilePath: %s (wrong platform)\n", "#{ont.acronym}:", sub.submissionId, sub.uploadFilePath)
      end
    else
      # This is likely an error
      printf("%-15s\t\tsubmission: %3d; uploadFilePath: %s\n", "#{ont.acronym}:", sub.submissionId, sub.uploadFilePath)
    end
  end
end

